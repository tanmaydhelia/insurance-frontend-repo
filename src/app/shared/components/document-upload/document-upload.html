<div class="document-upload bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
  <!-- Loading State -->
  @if (isFetching()) {
    <div class="p-12 flex flex-col items-center justify-center">
      <i class="pi pi-spin pi-spinner text-4xl text-indigo-600 mb-4"></i>
      <p class="text-gray-500">Loading documents...</p>
    </div>
  } @else {
    <!-- Header -->
    <div class="bg-linear-to-r from-indigo-600 to-purple-600 px-6 py-4">
      <div class="flex items-center gap-3">
        <div class="p-2 bg-white/20 rounded-lg">
          <i class="pi pi-id-card text-white text-xl"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-white">
            {{ mode() === 'create' ? 'Document Verification' : 'Your Documents' }}
          </h3>
          <p class="text-indigo-100 text-sm">
            {{ mode() === 'create' ? 'Submit your documents to proceed with enrollment' : 'Your verification documents are on file' }}
          </p>
        </div>
      </div>
    </div>

    <!-- Existing Documents View -->
    @if (existingDocuments() && !showEditForm()) {
      <div class="p-6 space-y-6">
        <!-- Success Badge -->
        <div class="bg-green-50 border border-green-200 rounded-xl p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                <i class="pi pi-check text-white text-lg"></i>
              </div>
              <div>
                <p class="font-semibold text-green-800">Documents Verified</p>
                <p class="text-sm text-green-600">Your identity documents are already on file</p>
              </div>
            </div>
            <button
              type="button"
              (click)="startEdit()"
              class="px-4 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-lg transition-colors flex items-center gap-2"
            >
              <i class="pi pi-pencil"></i>
              Update
            </button>
          </div>
        </div>

        <!-- Document Preview Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <!-- Aadhaar Info -->
          <div class="bg-gray-50 rounded-xl p-4">
            <div class="flex items-center gap-3 mb-3">
              <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
                <i class="pi pi-id-card text-indigo-600"></i>
              </div>
              <div>
                <p class="text-sm text-gray-500">Aadhaar Number</p>
                <p class="font-semibold text-gray-800">{{ existingDocuments()!.aadhaarNumber }}</p>
              </div>
            </div>
          </div>

          <!-- Photo Preview -->
          <div class="bg-gray-50 rounded-xl p-4">
            <p class="text-sm text-gray-500 mb-2">Photo</p>
            <img 
              [src]="existingDocuments()!.photoUrl" 
              alt="Profile Photo" 
              class="w-24 h-28 object-cover rounded-lg border-2 border-gray-200"
            />
          </div>

          <!-- Medical Document Preview -->
          <div class="bg-gray-50 rounded-xl p-4 md:col-span-2">
            <p class="text-sm text-gray-500 mb-2">Medical Checkup Document</p>
            @if (existingDocuments()!.medicalCheckupDocUrl.endsWith('.pdf')) {
              <a 
                [href]="existingDocuments()!.medicalCheckupDocUrl" 
                target="_blank"
                class="inline-flex items-center gap-2 px-4 py-2 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors"
              >
                <i class="pi pi-file-pdf text-xl"></i>
                View PDF Document
              </a>
            } @else {
              <img 
                [src]="existingDocuments()!.medicalCheckupDocUrl" 
                alt="Medical Document" 
                class="max-w-xs h-32 object-cover rounded-lg border-2 border-gray-200"
              />
            }
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 pt-4 border-t border-gray-200">
          <button
            type="button"
            (click)="cancel()"
            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-colors"
          >
            Close
          </button>
          <button
            type="button"
            (click)="onSuccess.emit(existingDocuments()!)"
            class="flex-1 px-6 py-3 bg-linear-to-r from-green-500 to-emerald-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all flex items-center justify-center gap-2"
          >
            <i class="pi pi-check"></i>
            Continue with Enrollment
          </button>
        </div>
      </div>
    }
    
    <!-- Upload/Edit Form - shown when no documents exist OR when editing -->
    @if (!existingDocuments() || showEditForm()) {
      <form [formGroup]="documentForm" (ngSubmit)="submit()" class="p-6 space-y-6">
        <!-- Edit Mode Header -->
        @if (showEditForm()) {
          <div class="bg-amber-50 border border-amber-200 rounded-xl p-4 mb-2">
            <div class="flex items-center gap-3">
              <i class="pi pi-info-circle text-amber-600"></i>
              <div>
                <p class="font-medium text-amber-800">Update Your Documents</p>
                <p class="text-sm text-amber-600">Fill in a new Aadhaar number and optionally upload new files. Leave file fields empty to keep existing ones.</p>
              </div>
            </div>
          </div>
        }
        
        <!-- Aadhaar Number -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Aadhaar Number <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="pi pi-id-card text-gray-400"></i>
            </div>
            <input
              type="text"
              formControlName="aadhaarNumber"
              (input)="formatAadhaar($event)"
              [value]="getAadhaarFormatted()"
              placeholder="XXXX-XXXX-XXXX"
              maxlength="14"
              class="block w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all"
            />
          </div>
          @if (documentForm.get('aadhaarNumber')?.touched && documentForm.get('aadhaarNumber')?.errors) {
            <p class="mt-2 text-sm text-red-600 flex items-center gap-1">
              <i class="pi pi-exclamation-circle"></i>
              @if (documentForm.get('aadhaarNumber')?.errors?.['required']) {
                Aadhaar number is required
              } @else if (documentForm.get('aadhaarNumber')?.errors?.['pattern']) {
                Enter a valid 12-digit Aadhaar (cannot start with 0 or 1)
              }
            </p>
          }
          <p class="mt-1 text-xs text-gray-500">
            <i class="pi pi-lock mr-1"></i>
            Your Aadhaar will be securely stored and masked for privacy
          </p>
        </div>

        <!-- Photo Upload -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Passport Size Photo 
            @if (!showEditForm()) {
              <span class="text-red-500">*</span>
            } @else {
              <span class="text-gray-400 text-xs">(leave empty to keep current)</span>
            }
          </label>
          
          @if (!photoPreview() && !photoFile) {
            <label class="flex flex-col items-center justify-center w-full h-40 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <i class="pi pi-cloud-upload text-3xl text-gray-400 mb-2"></i>
                <p class="mb-1 text-sm text-gray-600">
                  <span class="font-semibold text-indigo-600">Click to upload</span> or drag and drop
                </p>
                <p class="text-xs text-gray-500">PNG, JPG (MAX. 5MB)</p>
              </div>
              <input type="file" class="hidden" accept="image/*" (change)="onPhotoSelect($event)" />
            </label>
          } @else {
            <div class="flex items-end gap-4">
              <div class="relative inline-block">
                <img 
                  [src]="photoPreview()" 
                  alt="Photo preview" 
                  class="w-32 h-40 object-cover rounded-xl border-2 border-gray-200"
                />
                @if (photoFile) {
                  <button 
                    type="button"
                    (click)="removePhoto()"
                    class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors"
                  >
                    <i class="pi pi-times text-xs"></i>
                  </button>
                  <span class="absolute -bottom-2 left-1/2 -translate-x-1/2 text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">New</span>
                }
              </div>
              @if (showEditForm() && !photoFile) {
                <label class="px-4 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-lg transition-colors cursor-pointer flex items-center gap-2 border border-indigo-200">
                  <i class="pi pi-upload"></i>
                  Change Photo
                  <input type="file" class="hidden" accept="image/*" (change)="onPhotoSelect($event)" />
                </label>
              }
            </div>
          }
        </div>

        <!-- Medical Checkup Document -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Medical Checkup Document 
            @if (!showEditForm()) {
              <span class="text-red-500">*</span>
            } @else {
              <span class="text-gray-400 text-xs">(leave empty to keep current)</span>
            }
          </label>
          
          @if (!medicalDocPreview() && !medicalDocFile) {
            <label class="flex flex-col items-center justify-center w-full h-40 border-2 border-gray-300 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-colors">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <i class="pi pi-file-pdf text-3xl text-gray-400 mb-2"></i>
                <p class="mb-1 text-sm text-gray-600">
                  <span class="font-semibold text-indigo-600">Click to upload</span> or drag and drop
                </p>
                <p class="text-xs text-gray-500">PDF, PNG, JPG (MAX. 10MB)</p>
              </div>
              <input type="file" class="hidden" accept="image/*,.pdf" (change)="onMedicalDocSelect($event)" />
            </label>
          } @else {
            <div class="flex items-end gap-4">
              <div class="relative inline-block">
                @if (medicalDocPreview() === 'pdf') {
                  <div class="w-32 h-40 bg-red-50 rounded-xl border-2 border-red-200 flex flex-col items-center justify-center">
                    <i class="pi pi-file-pdf text-4xl text-red-500 mb-2"></i>
                    <span class="text-xs text-gray-600">PDF Document</span>
                  </div>
                } @else {
                  <img 
                    [src]="medicalDocPreview()" 
                    alt="Medical doc preview" 
                    class="w-32 h-40 object-cover rounded-xl border-2 border-gray-200"
                  />
                }
                @if (medicalDocFile) {
                  <button 
                    type="button"
                    (click)="removeMedicalDoc()"
                    class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 transition-colors"
                  >
                    <i class="pi pi-times text-xs"></i>
                  </button>
                  <span class="absolute -bottom-2 left-1/2 -translate-x-1/2 text-xs bg-green-500 text-white px-2 py-0.5 rounded-full">New</span>
                }
              </div>
              @if (showEditForm() && !medicalDocFile) {
                <label class="px-4 py-2 text-sm font-medium text-indigo-600 hover:text-indigo-800 hover:bg-indigo-50 rounded-lg transition-colors cursor-pointer flex items-center gap-2 border border-indigo-200">
                  <i class="pi pi-upload"></i>
                  Change Document
                  <input type="file" class="hidden" accept="image/*,.pdf" (change)="onMedicalDocSelect($event)" />
                </label>
              }
            </div>
          }
        </div>

        <!-- Info Box -->
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
          <div class="flex items-start gap-3">
            <i class="pi pi-info-circle text-blue-600 mt-0.5"></i>
            <div class="text-sm text-blue-700">
              <p class="font-medium mb-1">Why we need these documents?</p>
              <ul class="list-disc list-inside space-y-1 text-blue-600">
                <li>Aadhaar verification for identity confirmation</li>
                <li>Photo for policy documentation</li>
                <li>Medical checkup for health assessment</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-4 pt-4">
          <button
            type="button"
            (click)="showEditForm() ? cancelEdit() : cancel()"
            class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl font-semibold hover:bg-gray-200 transition-colors"
          >
            {{ showEditForm() ? 'Cancel Update' : 'Cancel' }}
          </button>
          <button
            type="submit"
            [disabled]="!isFormValid() || isLoading()"
            class="flex-1 px-6 py-3 bg-linear-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg hover:shadow-indigo-500/30 transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            @if (isLoading()) {
              <i class="pi pi-spin pi-spinner"></i>
              {{ showEditForm() ? 'Updating...' : 'Uploading...' }}
            } @else {
              <i class="pi pi-check"></i>
              {{ showEditForm() ? 'Update Documents' : 'Submit Documents' }}
            }
          </button>
        </div>
      </form>
    }
  }
</div>
